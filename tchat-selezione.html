<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tchat SELEZIONE PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <style>
    body {
      background: #191919;
      color: #fff;
      font-family: 'Segoe UI', 'Arial', sans-serif;
      margin: 0;
    }
    .chat-container {
      max-width: 500px;
      margin: 3em auto;
      background: #232323;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      overflow: hidden;
      padding-bottom: 1em;
    }
    .chat-header {
      background: linear-gradient(90deg, #FFD600 0%, #B29000 100%);
      color: #191919;
      font-weight: 700;
      padding: 1.1em 1.2em;
      font-size: 1.3em;
      display: flex;
      align-items: center;
      gap: 0.5em;
      border-bottom: 3px solid #282828;
    }
    .chat-header svg {
      width: 1.5em;
      height: 1.5em;
      vertical-align: middle;
    }
    .messages-area {
      background: #222;
      min-height: 250px;
      max-height: 350px;
      overflow-y: auto;
      padding: 1.2em 1em 0.5em 1em;
      display: flex;
      flex-direction: column;
      gap: 0.4em;
      border-bottom: 2px solid #282828;
    }
    .message-bubble {
      display: inline-block;
      padding: 0.7em 1em;
      margin-bottom: 0.1em;
      border-radius: 17px;
      font-size: 1em;
      max-width: 80%;
      word-break: break-word;
      box-shadow: 0 2px 8px rgba(0,0,0,0.13);
      position: relative;
      line-height: 1.4;
    }
    .message-me {
      background: linear-gradient(120deg,#ffd600 60%,#ffe370 100%);
      color: #000;
      align-self: flex-end;
      border-bottom-right-radius: 3px;
    }
    .message-other {
      background: #393939;
      color: #fff;
      align-self: flex-start;
      border-bottom-left-radius: 3px;
    }
    .message-pseudo {
      font-size: 0.9em;
      font-weight: bold;
      opacity: 0.8;
      margin-bottom: 0.2em;
      display: block;
    }
    .chat-input-area {
      display: flex;
      gap: 0.5em;
      padding: 1em 1em 0 1em;
      align-items: center;
      flex-wrap: wrap;
    }
    .chat-input-area input[type="text"] {
      background: #181818;
      border: none;
      border-radius: 8px;
      padding: 0.7em 1em;
      color: #fff;
      font-size: 1em;
      outline: none;
      transition: box-shadow 0.2s;
      flex: 1;
      margin: 0;
    }
    .chat-input-area input[type="text"]:first-child {
      max-width: 7em;
      flex: unset;
    }
    .chat-input-area button {
      background: linear-gradient(90deg, #ffd600 0%, #b29000 100%);
      color: #191919;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 0.7em 1.2em;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
      margin-left: 0.5em;
      box-shadow: 0 2px 12px rgba(0,0,0,0.11);
      flex-shrink: 0;
    }
    .chat-input-area button:active {
      background: #ffe370;
    }
    @media (max-width:600px) {
      .chat-container { max-width: 99vw; margin: 0.5em; }
      .chat-header { font-size: 1.1em; padding: 1em 0.8em; }
      .chat-input-area { flex-direction: column; gap: 0.6em; padding: 1em 0.5em 0 0.5em;}
      .chat-input-area input[type="text"] { width: 100%; }
      .chat-input-area input[type="text"]:first-child { max-width: 100%; }
      .chat-input-area button { width: 100%; margin-left: 0; }
      .messages-area { max-height: 40vh; }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#fff"/><path d="M6 17v-1.5C6 13.12 9.33 12 12 12s6 .88 6 3.5V17" fill="none" stroke="#FFD600" stroke-width="1.7"/><circle cx="12" cy="8.5" r="3.2" fill="none" stroke="#FFD600" stroke-width="1.7"/></svg>
      Tchat SELEZIONE PRO
    </div>
    <div class="messages-area" id="messages"></div>
    <!-- ON GARDE LE FORM EN LIGNE -->
    <form class="chat-input-area" id="chatForm">
      <input type="text" id="pseudo" placeholder="Pseudo" value="Selezione" autocomplete="username" />
      <input type="text" id="msg" placeholder="Message" autocomplete="off" />
      <button type="submit" id="envoyerBtn">Envoyer</button>
    </form>
    <div id="debug" style="padding:0.6em 1em;color:#ffd600;font-size:0.98em"></div>
  </div>
  <script>
    // CONFIG SUPABASE
    const SUPABASE_URL = "https://gwcatbpsjbbhwekcsvkr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3Y2F0YnBzamJiaHdla2NzdmtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyMTMzNDUsImV4cCI6MjA2Mzc4OTM0NX0.wMu7xBYKSUyzbcRRKDPGjX6iowDh9wdXFjyB71hl_to";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // UTIL: Sélecteur
    const $ = sel => document.querySelector(sel);

    // Affiche les messages dans la bulle WhatsApp style
    function afficherMessages(data, pseudoCourant) {
      const messages = data.map(msg => {
        const isMe = msg.pseudo?.trim().toLowerCase() === pseudoCourant.trim().toLowerCase();
        return `
          <div class="message-bubble ${isMe ? "message-me" : "message-other"}">
            <span class="message-pseudo">${msg.pseudo || "?"}</span>
            ${msg.content}
          </div>
        `;
      }).join('');
      $('#messages').innerHTML = messages;
      $('#messages').scrollTop = 9999999; // scroll down
    }

    // Lecture au chargement
    let pseudoMemo = '';
    document.addEventListener("DOMContentLoaded", async () => {
      $('#debug').innerText = "Lecture des messages...";
      pseudoMemo = $('#pseudo').value;
      await chargerMessages();
      // Rafraîchissement auto toutes les 4s
      setInterval(chargerMessages, 4000);
    });

    async function chargerMessages() {
      const pseudoCourant = $('#pseudo').value;
      const { data, error } = await supabase.from('message').select('*').order('created_at', { ascending: true });
      if (error) {
        $('#debug').innerText = "Erreur Supabase : " + error.message;
      } else {
        $('#debug').innerText = "Nb messages : " + (data?.length || 0);
        afficherMessages(data || [], pseudoCourant);
      }
    }

    // Envoi d'un message
    async function envoyer() {
      const pseudo = $('#pseudo').value.trim();
      const msg = $('#msg').value.trim();
      if(!pseudo || !msg) return;
      $('#msg').value = '';
      $('#msg').focus();
      // Ajoute en base
      const { error } = await supabase.from('message').insert([{ pseudo, content: msg }]);
      if (error) {
        $('#debug').innerText = "Erreur lors de l'envoi: "+error.message;
      } else {
        await chargerMessages();
      }
    }

    // Interception propre du submit
    $('#chatForm').addEventListener("submit", function(e) {
      e.preventDefault();
      envoyer();
    });

    // ENTER = envoyer
    $('#msg').addEventListener("keydown", e => {
      if(e.key==="Enter") {
        e.preventDefault();
        envoyer();
      }
    });
  </script>
</body>
</html>
