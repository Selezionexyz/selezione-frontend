<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ðŸ’¬ Tchat SELEZIONE</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { background: #111; color: #fff; font-family: 'Outfit', sans-serif; margin:0; }
    .chat-container { max-width: 600px; margin: 2rem auto; padding: 1rem; background: #222; border-radius: 14px; box-shadow: 0 2px 20px #000a; }
    .messages { min-height: 350px; max-height: 400px; overflow-y: auto; margin-bottom: 1rem; border:1px solid #333; border-radius:7px; background:#181818; padding:12px; }
    .message { margin: .5rem 0; }
    .sender { color: gold; font-weight: bold; }
    .date { color: #aaa; font-size: 0.8em; margin-left: 5px;}
    .input-row { display: flex; gap: .7rem; }
    input, button { font-size: 1em; border-radius: 5px; border:none; padding: .5em; }
    input { flex: 1; }
    button { background: gold; color: #111; font-weight: bold; cursor: pointer; }
    .system { color: #89f; font-size: 0.93em; }
  </style>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // --- CONFIG
    const SUPABASE_URL = "https://gwcatbpsjbbhwekcsvkr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3Y2F0YnBzamJiaHdla2NzdmtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyMTMzNDUsImV4cCI6MjA2Mzc4OTM0NX0.wMu7xBYKSUyzbcRRKDPGjX6iowDh9wdXFjyB71hl_to";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- Elements
    const loginBlock = document.getElementById('login-block');
    const chatBlock = document.getElementById('chat-block');
    const messagesDiv = document.getElementById('messages');
    const authMsg = document.getElementById('auth-msg');
    let currentUser = null;

    // --- Auth logic
    window.signup = async function() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      authMsg.innerText = '';
      if (!email || !password) return authMsg.innerText = "Email et mot de passe requis.";
      const { error } = await supabase.auth.signUp({ email, password });
      authMsg.innerText = error ? error.message : "Compte crÃ©Ã©, vÃ©rifie tes mails pour valider.";
    };

    window.login = async function() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      authMsg.innerText = '';
      if (!email || !password) return authMsg.innerText = "Email et mot de passe requis.";
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return authMsg.innerText = error.message;
      currentUser = data.user;
      loginBlock.style.display = 'none';
      chatBlock.style.display = '';
      loadMessages();
      listenMessages();
    };

    window.logout = async function() {
      await supabase.auth.signOut();
      currentUser = null;
      loginBlock.style.display = '';
      chatBlock.style.display = 'none';
      messagesDiv.innerHTML = '';
    };

    // --- Affichage auto si dÃ©jÃ  connectÃ©
    supabase.auth.getUser().then(({ data }) => {
      if (data.user) {
        currentUser = data.user;
        loginBlock.style.display = 'none';
        chatBlock.style.display = '';
        loadMessages();
        listenMessages();
      }
    });

    // --- Charger les messages
    async function loadMessages() {
      messagesDiv.innerHTML = '<div class="system">Chargementâ€¦</div>';
      let { data, error } = await supabase.from('messages').select('*').order('created_at', { ascending: true }).limit(100);
      if (error) return messagesDiv.innerHTML = "<span style='color:red;'>Erreur chargement messages</span>";
      renderMessages(data || []);
    }

    // --- Afficher les messages
    function renderMessages(msgs) {
      messagesDiv.innerHTML = '';
      msgs.forEach(msg => {
        messagesDiv.innerHTML += `
          <div class="message">
            <span class="sender">${msg.sender}</span>
            <span class="date">${(new Date(msg.created_at)).toLocaleString('fr-FR').slice(0, -3)}</span> : 
            ${escapeHtml(msg.content)}
          </div>
        `;
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // --- Envoyer un message
    window.sendMessage = async function() {
      const input = document.getElementById('msg-input');
      const txt = input.value.trim();
      if (!txt || !currentUser) return;
      let sender = currentUser.email;
      // Tu peux ici remplacer par pseudo si tu veux dans la table user
      await supabase.from('messages').insert([{ sender, content: txt }]);
      input.value = '';
    };

    // --- Realtime listener
    function listenMessages() {
      supabase
        .channel('public:messages')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          addSingleMessage(payload.new);
        })
        .subscribe();
    }
    function addSingleMessage(msg) {
      messagesDiv.innerHTML += `
        <div class="message">
          <span class="sender">${msg.sender}</span>
          <span class="date">${(new Date(msg.created_at)).toLocaleString('fr-FR').slice(0, -3)}</span> : 
          ${escapeHtml(msg.content)}
        </div>
      `;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // --- SÃ©curitÃ© anti XSS
    function escapeHtml(text) {
      return text.replace(/[<>&"]/g, c => ({
        '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;'
      })[c]);
    }

    // --- ENTRÃ‰E clavier
    document.getElementById('msg-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') sendMessage();
    });

  </script>
</head>
<body>
  <div class="chat-container">
    <h2>ðŸ’¬ Tchat SELEZIONE</h2>
    <div id="login-block">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Mot de passe" required>
      <button onclick="login()">Connexion</button>
      <button onclick="signup()">CrÃ©er un compte</button>
      <div id="auth-msg" style="color:#f66"></div>
    </div>
    <div id="chat-block" style="display:none;">
      <div class="messages" id="messages"></div>
      <div class="input-row">
        <input type="text" id="msg-input" placeholder="Votre message...">
        <button onclick="sendMessage()">Envoyer</button>
      </div>
      <button onclick="logout()" style="margin-top:10px;">DÃ©connexion</button>
    </div>
  </div>
</body>
</html>
