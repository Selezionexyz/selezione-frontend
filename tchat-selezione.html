<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ðŸ’¬ Tchat SELEZIONE</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { background: #111; color: #fff; font-family: 'Outfit', sans-serif; margin:0; }
    .chat-container { max-width: 600px; margin: 2rem auto; padding: 1rem; background: #222; border-radius: 14px; box-shadow: 0 2px 20px #000a; }
    .messages { min-height: 350px; max-height: 400px; overflow-y: auto; margin-bottom: 1rem; border:1px solid #333; border-radius:7px; background:#181818; padding:12px; }
    .message { margin: .5rem 0; }
    .sender { color: gold; font-weight: bold; }
    .date { color: #aaa; font-size: 0.8em; margin-left: 5px;}
    .input-row { display: flex; gap: .7rem; }
    input, button { font-size: 1em; border-radius: 5px; border:none; padding: .5em; }
    input { flex: 1; }
    button { background: gold; color: #111; font-weight: bold; cursor: pointer; }
    #pseudo-row {margin-bottom: 1.2em;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
</head>
<body>
  <div class="chat-container">
    <h2>ðŸ’¬ Tchat SELEZIONE</h2>
    <div id="pseudo-row">
      <input type="text" id="pseudo" placeholder="Ton pseudo (visible)" maxlength="18">
      <button onclick="enterChat()">Entrer</button>
    </div>
    <div id="chat-block" style="display:none;">
      <div class="messages" id="messages"></div>
      <div class="input-row">
        <input type="text" id="msg-input" placeholder="Votre message...">
        <button onclick="sendMessage()">Envoyer</button>
      </div>
    </div>
  </div>
  <script>
    const SUPABASE_URL = "https://gwcatbpsjbbhwekcsvkr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3Y2F0YnBzamJiaHdla2NzdmtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyMTMzNDUsImV4cCI6MjA2Mzc4OTM0NX0.wMu7xBYKSUyzbcRRKDPGjX6iowDh9wdXFjyB71hl_to";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentPseudo = "";

    async function enterChat() {
      const pseudo = document.getElementById('pseudo').value.trim();
      if (!pseudo) {
        alert('Choisis un pseudo pour entrer dans le tchat !');
        return;
      }
      currentPseudo = pseudo;
      document.getElementById('pseudo-row').style.display = 'none';
      document.getElementById('chat-block').style.display = '';
      fetchMessages();
      subscribeMessages();
    }

    async function sendMessage() {
      const input = document.getElementById('msg-input');
      const content = input.value.trim();
      if (!content) return;
      await supabase.from('messages').insert([{ sender: currentPseudo, content }]);
      input.value = '';
    }

    async function fetchMessages() {
      let { data: messages } = await supabase.from('messages').select('*').order('created_at', { ascending: true });
      renderMessages(messages);
    }

    function subscribeMessages() {
      supabase
        .channel('public:messages')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          fetchMessages();
        })
        .subscribe();
    }

    function renderMessages(messages) {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';
      messages.forEach(msg => {
        const date = new Date(msg.created_at).toLocaleTimeString();
        messagesDiv.innerHTML += `<div class="message"><span class="sender">${msg.sender}</span> <span class="date">${date}</span><br>${msg.content}</div>`;
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  </script>
</body>
</html>
