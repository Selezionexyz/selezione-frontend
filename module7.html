// Module 7 : Backend Express pour gestion des commandes SELEZIONE

const express = require('express'); const cors = require('cors'); const bodyParser = require('body-parser'); const nodemailer = require('nodemailer'); const { createClient } = require('@supabase/supabase-js'); require('dotenv').config();

const app = express(); const PORT = process.env.PORT || 3000;

// Middlewares app.use(cors()); app.use(bodyParser.json());

// Supabase client const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);

// Nodemailer config (pour e-mail notification admin) const transporter = nodemailer.createTransport({ service: 'gmail', auth: { user: process.env.ADMIN_EMAIL, pass: process.env.ADMIN_EMAIL_PASSWORD, }, });

// Enregistrer une commande app.post('/api/commande', async (req, res) => { const { user, fichier, selections } = req.body;

try { // Enregistrement dans Supabase const { error } = await supabase.from('commandes').insert({ user, fichier, selections, created_at: new Date().toISOString(), });

if (error) throw error;

// Notification e-mail
await transporter.sendMail({
  from: process.env.ADMIN_EMAIL,
  to: process.env.ADMIN_EMAIL,
  subject: `Nouvelle commande SELEZIONE de ${user}`,
  html: `Fichier: <b>${fichier}</b><br/>Commande: <pre>${JSON.stringify(selections, null, 2)}</pre>`,
});

res.status(200).json({ message: 'Commande enregistrÃ©e et notifiÃ©e avec succÃ¨s.' });

} catch (err) { console.error('Erreur commande :', err); res.status(500).json({ error: 'Erreur lors de lâ€™enregistrement de la commande.' }); } });

app.listen(PORT, () => { console.log(ðŸš€ Serveur backend SELEZIONE lancÃ© sur le port ${PORT}); });
